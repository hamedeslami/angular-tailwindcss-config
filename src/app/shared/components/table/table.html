<div class="overflow-hidden rounded-2xl border border-gray-200 bg-white dark:border-white/[0.05] dark:bg-white/[0.03]">
  @if(activeFilters().length > 0){
  <div class="p-4 border-b border-gray-200 dark:border-white/[0.05] bg-gray-50 dark:bg-gray-900">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">فیلترهای فعال:</span>
      <button (click)="clearAllFilters()"
        class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors">
        پاک کردن همه
      </button>
    </div>
    <div class="flex flex-wrap gap-2">
      @for(filter of activeFilters(); track filter.key){
      <div
        class="flex items-center gap-2 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg px-3 py-1.5">
        <span class="text-xs font-medium text-blue-700 dark:text-blue-300">
          {{ getFilterLabel(filter.key) }}:
        </span>
        <span class="text-xs text-blue-600 dark:text-blue-400">
          {{ getFilterDisplayValue(filter) }}
        </span>
        <button (click)="removeSpecificFilter(filter)"
          class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      }
    </div>
  </div>
  }

  <div class="max-w-full overflow-x-auto">
    <table class="min-w-full">
      <thead class="px-6 py-3.5 border-t border-gray-100 border-y bg-gray-100 dark:border-white/[0.05] dark:bg-gray-900">
        <tr>
          @if(selectable()){
          <th class="px-6 py-3 font-medium text-gray-500 sm:px-6 text-xs dark:text-gray-400 text-start">
            <div class="flex items-center gap-3">
              <div>
                <app-checkbox [checked]="selectAll" (checkedChange)="toggleAll()" />
              </div>
            </div>
          </th>
          }
          @for (col of columns(); track col.key){
          <th class="px-6 py-3 font-medium text-gray-500 sm:px-6 text-xs dark:text-gray-400 text-start relative">
            <div class="flex items-center gap-2">
              @if(isSortable(col.key)){
              <button class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-300 transition-colors"
                (click)="toggleSort(col.key)" [class.text-blue-500]="getSortDirection(col.key) !== 'none'">
                <span>{{ col.label }}</span>
                <div class="flex flex-col">
                  <svg class="w-3 h-3" [class.text-blue-500]="getSortDirection(col.key) === 'asc'"
                    [class.text-gray-400]="getSortDirection(col.key) !== 'asc'" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                  </svg>
                  <svg class="w-3 h-3 -mt-1" [class.text-blue-500]="getSortDirection(col.key) === 'desc'"
                    [class.text-gray-400]="getSortDirection(col.key) !== 'desc'" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </button>
              } @else {
              <span>{{ col.label }}</span>
              }

              @if(getFilterConfig(col.key)){
              <div class="relative">
                <button class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
                  (click)="toggleFilterMenu(col.key)" [class.bg-blue-50]="hasFilter(col.key)"
                  [class.text-blue-500]="hasFilter(col.key)">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                  </svg>
                </button>

                @if(openFilterMenu() === col.key){
                <div
                  class="absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-10 min-w-48">
                  <div class="p-3">
                    @let filterConfig = getFilterConfig(col.key);
                    @if(filterConfig){
                    @switch(filterConfig.type){
                    @case('text'){
                    <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        فیلتر {{ col.label }}
                      </label>
                      <input type="text"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                        #filterInput [value]="getCurrentFilterValue(col.key)"
                        (keyup.enter)="applyFilter(col.key, filterInput.value)" placeholder="مقدار برای جستجو..." />
                      <div class="flex gap-2 mt-2">
                        <button
                          class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors"
                          (click)="applyFilter(col.key, filterInput.value)">
                          اعمال
                        </button>
                        @if(hasFilter(col.key)){
                        <button
                          class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors"
                          (click)="removeFilter(col.key)">
                          حذف
                        </button>
                        }
                      </div>
                    </div>
                    }
                    @case('select'){
                    <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        فیلتر {{ col.label }}
                      </label>
                      <select
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                        #filterSelect [value]="getCurrentFilterValue(col.key) || ''"
                        (change)="applyFilter(col.key, filterSelect.value)">
                        <option value="">همه</option>
                        @for(option of filterConfig.options; track option.value){
                        <option [value]="option.value" [selected]="getCurrentFilterValue(col.key) === option.value">{{ option.label }}</option>
                        }
                      </select>
                      @if(hasFilter(col.key)){
                      <button
                        class="w-full mt-2 px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors"
                        (click)="removeFilter(col.key)">
                        حذف فیلتر
                      </button>
                      }
                    </div>
                    }
                    @case('date'){
                    <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        فیلتر {{ col.label }}
                      </label>
                      <input type="date"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                        #dateInput [value]="getCurrentFilterValue(col.key)"
                        (change)="applyFilter(col.key, dateInput.value)" />
                      @if(hasFilter(col.key)){
                      <button
                        class="w-full mt-2 px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors"
                        (click)="removeFilter(col.key)">
                        حذف فیلتر
                      </button>
                      }
                    </div>
                    }
                    }
                    }
                  </div>
                </div>
                }
              </div>
              }
            </div>
          </th>
          }
        </tr>
      </thead>
      <tbody>
        @for (row of data(); track row.id){
        <tr class="hover:bg-gray-100 dark:hover:bg-gray-800">
          @if(selectable()){
          <td class="px-4 sm:px-6 py-3.5">
            <div class="flex items-center gap-3">
              <div>
                <app-checkbox [checked]="selectedRows.includes(row.id)" (checkedChange)="toggleRow(row.id)" />
              </div>
            </div>
          </td>
          } @for (col of columns(); track col.key) {
          <td class="px-4 sm:px-6 py-3.5 text-gray-700 text-sm dark:text-gray-400">
            @if (col.templateName && templateMap()[col.templateName]) {
            <ng-container [ngTemplateOutlet]="templateMap()[col.templateName].template"
              [ngTemplateOutletContext]="{ $implicit: row, row: row }">
            </ng-container>
            } @else { {{ getValue(row, col.key) }} }
          </td>
          }
        </tr>
        }
      </tbody>
    </table>
  </div>
</div>